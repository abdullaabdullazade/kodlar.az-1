---
import Window from "./Window.astro";
---

<div class="search-modal" id="search-modal">
  <div class="search-modal-backdrop" id="search-backdrop"></div>
  <div class="search-modal-content">
    <Window title="axtar" mono>
      <div class="search-input-row">
        <span class="prompt">$</span>
        <span class="cmd">grep</span>
        <input
          type="text"
          id="search-input"
          placeholder="məqalə axtar..."
          autofocus
        />
      </div>
      <div class="search-results" id="search-results">
        <p class="hint">// nəticələr burada görünəcək</p>
      </div>
    </Window>
  </div>
</div>

<style>
  .search-modal {
    position: fixed;
    inset: 0;
    z-index: 200;
    display: none;
    align-items: flex-start;
    justify-content: center;
    padding-top: 10vh;
  }

  .search-modal.active {
    display: flex;
  }

  .search-modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
  }

  .search-modal-content {
    position: relative;
    width: 100%;
    max-width: 560px;
    margin: 0 1rem;
  }

  .search-input-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    font-family: var(--font-mono);
  }

  .search-input-row .prompt {
    color: var(--color-green);
  }

  .search-input-row .cmd {
    color: var(--color-cyan);
  }

  .search-input-row input {
    flex: 1;
    padding: 0.5rem 0.75rem;
    font-family: var(--font-mono);
    font-size: 0.875rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    outline: none;
  }

  .search-input-row input:focus {
    border-color: var(--color-primary);
  }

  .search-results {
    max-height: 300px;
    overflow-y: auto;
  }

  .search-results .hint {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--color-text-muted);
    text-align: center;
    padding: 1rem;
  }

  .search-result-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    margin-bottom: 0.5rem;
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .search-result-item:hover {
    border-color: var(--color-primary);
    background: var(--color-primary-muted);
  }

  .search-result-item.selected {
    border-color: var(--color-primary);
    border-left: 4px solid var(--color-primary);
    background: rgba(99, 102, 241, 0.25);
    box-shadow:
      0 0 0 2px var(--color-primary-muted),
      inset 0 0 20px rgba(99, 102, 241, 0.1);
  }

  .search-result-item.selected .title {
    color: var(--color-primary);
  }

  .result-left {
    flex: 1;
    min-width: 0;
  }

  .search-result-item .title {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text);
    margin-bottom: 0.25rem;
  }

  .search-result-item .desc {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .result-hint {
    font-family: var(--font-mono);
    font-size: 0.625rem;
    color: var(--color-text-muted);
    padding: 0.25rem 0.5rem;
    background: var(--color-bg-secondary);
    border-radius: var(--radius-sm);
    opacity: 0;
    transition: opacity var(--transition-fast);
  }

  .search-result-item.selected .result-hint {
    opacity: 1;
  }
</style>

<script>
  function initSearch() {
    const triggers = document.querySelectorAll(".search-trigger");
    const modal = document.getElementById("search-modal");
    const backdrop = document.getElementById("search-backdrop");
    const input = document.getElementById("search-input") as HTMLInputElement;
    const results = document.getElementById("search-results");
    const windowEl = modal?.querySelector(".window") as HTMLElement;
    const windowCloseBtn = modal?.querySelector('[data-action="close"]');

    function openModal() {
      modal?.classList.add("active");
      if (windowEl) windowEl.style.display = "";
      input?.focus();
    }

    function closeModal() {
      modal?.classList.remove("active");
      if (input) input.value = "";
      if (results)
        results.innerHTML = '<p class="hint">// nəticələr burada görünəcək</p>';
    }

    // Ctrl+K to open
    document.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "k") {
        e.preventDefault();
        openModal();
      }
      if (e.key === "Escape") {
        closeModal();
      }
    });

    triggers.forEach((trigger) => {
      trigger.addEventListener("click", openModal);
    });
    backdrop?.addEventListener("click", closeModal);

    // Override Window's close button to use our closeModal
    windowCloseBtn?.addEventListener("click", (e) => {
      e.stopPropagation();
      closeModal();
    });

    let selectedIndex = -1;
    let currentMatches: { title: string; desc: string; href: string }[] = [];

    function updateSelection() {
      // Ensure selectedIndex is valid
      if (selectedIndex < 0) selectedIndex = 0;
      if (selectedIndex >= currentMatches.length)
        selectedIndex = currentMatches.length - 1;

      // Re-render with new selection
      renderResults();

      // Scroll selected item into view
      const items = results?.querySelectorAll(".search-result-item");
      if (items && items[selectedIndex]) {
        const element = items[selectedIndex] as HTMLElement;
        const container = results as HTMLElement;

        const elementTop = element.offsetTop;
        const elementBottom = elementTop + element.offsetHeight;
        const containerTop = container.scrollTop;
        const containerBottom = containerTop + container.clientHeight;

        if (elementTop < containerTop) {
          container.scrollTop = elementTop;
        } else if (elementBottom > containerBottom) {
          container.scrollTop = elementBottom - container.clientHeight;
        }
      }
    }

    function renderResults() {
      if (!results) return;

      if (currentMatches.length === 0) {
        results.innerHTML = '<p class="hint">// heç bir nəticə tapılmadı</p>';
        return;
      }

      results.innerHTML = currentMatches
        .map((m, i) => {
          const isSelected = i === selectedIndex;
          const selectedStyle = isSelected
            ? "border-left: 4px solid #6366f1; background: rgba(99, 102, 241, 0.2);"
            : "";
          return `
          <a href="${m.href}" class="search-result-item${isSelected ? " selected" : ""}" data-index="${i}" style="${selectedStyle}">
            <div class="result-left" style="display: flex; align-items: center; gap: 8px;">
              <span class="selection-indicator" style="color: #6366f1; font-size: 12px; opacity: ${isSelected ? "1" : "0"};">▶</span>
              <div>
                <div class="title" style="${isSelected ? "color: #6366f1;" : ""}">${m.title}</div>
                <div class="desc">${m.desc.substring(0, 80)}...</div>
              </div>
            </div>
            <div class="result-hint">Enter ↵</div>
          </a>
        `;
        })
        .join("");
    }

    // Shared search matching function
    function matchesSearchQuery(
      query: string,
      title: string,
      desc: string,
    ): boolean {
      if (!query) return true;
      const normalizedQuery = query.toLowerCase().trim();
      return (
        title.toLowerCase().includes(normalizedQuery) ||
        desc.toLowerCase().includes(normalizedQuery)
      );
    }

    // Search functionality
    input?.addEventListener("input", () => {
      const query = input.value.toLowerCase().trim();

      if (!query) {
        currentMatches = [];
        selectedIndex = -1;
        if (results)
          results.innerHTML = '<p class="hint">// axtarış üçün yazın</p>';
        return;
      }

      // Get all blog links from page
      const items = document.querySelectorAll("[data-search-title]");
      currentMatches = [];

      items.forEach((item) => {
        const title = item.getAttribute("data-search-title") || "";
        const desc = item.getAttribute("data-search-desc") || "";

        if (matchesSearchQuery(query, title, desc)) {
          currentMatches.push({
            title: title,
            desc: desc,
            href: item.getAttribute("href") || "",
          });
        }
      });

      // Always start with first item selected
      selectedIndex = currentMatches.length > 0 ? 0 : -1;

      renderResults();
      // Apply selection styling after render
      if (selectedIndex >= 0) {
        updateSelection();
      }
    });

    // Keyboard navigation
    input?.addEventListener("keydown", (e) => {
      if (currentMatches.length === 0) return;

      switch (e.key) {
        case "ArrowDown":
        case "Tab":
          e.preventDefault();
          if (selectedIndex < 0) {
            selectedIndex = 0;
          } else {
            selectedIndex = (selectedIndex + 1) % currentMatches.length;
          }
          updateSelection();
          break;
        case "ArrowUp":
          e.preventDefault();
          if (selectedIndex < 0) {
            selectedIndex = currentMatches.length - 1;
          } else {
            selectedIndex =
              selectedIndex <= 0
                ? currentMatches.length - 1
                : selectedIndex - 1;
          }
          updateSelection();
          break;
        case "PageDown":
          e.preventDefault();
          if (selectedIndex < 0) {
            selectedIndex = 0;
          } else {
            selectedIndex = Math.min(
              selectedIndex + 5,
              currentMatches.length - 1,
            );
          }
          updateSelection();
          break;
        case "PageUp":
          e.preventDefault();
          if (selectedIndex < 0) {
            selectedIndex = 0;
          } else {
            selectedIndex = Math.max(selectedIndex - 5, 0);
          }
          updateSelection();
          break;
        case "Enter":
          e.preventDefault();
          if (selectedIndex >= 0 && currentMatches[selectedIndex]) {
            window.location.href = currentMatches[selectedIndex].href;
          }
          break;
        case "Home":
          e.preventDefault();
          selectedIndex = 0;
          updateSelection();
          break;
        case "End":
          e.preventDefault();
          selectedIndex = currentMatches.length - 1;
          updateSelection();
          break;
      }
    });
  }

  // Initialize on page load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initSearch);
  } else {
    initSearch();
  }

  // Re-initialize on navigation (for SPAs)
  document.addEventListener("astro:page-load", initSearch);
  document.addEventListener("astro:after-swap", initSearch);
</script>
