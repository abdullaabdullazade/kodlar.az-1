---
import BaseLayout from "../../layouts/BaseLayout.astro";
import BlogList from "../../components/BlogList.astro";
import Button from "../../components/Button.astro";
import Icon from "../../components/Icon.astro";
import Window from "../../components/Window.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import { CONTRIBUTING_URL } from "../../config";

const allPosts = await getCollection("blog");
const sortedPosts = allPosts.sort(
  (a: CollectionEntry<"blog">, b: CollectionEntry<"blog">) =>
    b.data.date.valueOf() - a.data.date.valueOf(),
);
const allCategories = [
  ...new Set(
    allPosts.flatMap((post: CollectionEntry<"blog">) => post.data.categories),
  ),
];
---

<BaseLayout title="Məqalələr" currentPath="/blogs">
  <div class="page-container">
    <div class="content-area">
      <Window title="blogs" class="page-header" mono>
        <div class="search-row">
          <span class="prompt">$</span>
          <span class="cmd">grep</span>
          <input
            type="text"
            id="blog-search"
            placeholder="məqalə_axtar..."
            class="search-input"
          />
        </div>

        <div class="filter-section">
          <div class="cmd-line">
            <span class="comment">// kateqoriyalar</span>
          </div>
          <div class="filter-list" id="category-filters">
            <button class="filter-btn active" data-category="all">hamısı</button
            >
            {
              allCategories.map((cat) => (
                <button class="filter-btn" data-category={cat}>
                  {cat}
                </button>
              ))
            }
          </div>
        </div>
      </Window>

      <div class="active-bar" id="active-filters" style="display: none;">
        <span class="comment">// aktiv_filtrlər:</span>
        <div class="active-tags" id="filter-tags"></div>
        <button class="clear-btn" id="clear-filters">təmizlə()</button>
      </div>

      <BlogList posts={sortedPosts} />

      <div id="empty-state" style="display: none;">
        <Window class="empty-box" mono>
          <div class="empty-content">
            <div class="shrug">¯\_(ツ)_/¯</div>
            <p class="empty-msg">Heç bir nəticə tapılmadı</p>
            <button class="reset-btn" id="reset-filters">filter.reset()</button>
          </div>
        </Window>
      </div>
    </div>

    <aside class="sidebar">
      <div class="sidebar-card">
        <h3><span class="comment">// </span>sırala</h3>
        <div class="sort-list" id="sort-options">
          <button class="sort-btn active" data-sort="date-desc"
            >sort.date("desc")</button
          >
          <button class="sort-btn" data-sort="date-asc">sort.date("asc")</button
          >
          <button class="sort-btn" data-sort="title-asc"
            >sort.title("a-z")</button
          >
          <button class="sort-btn" data-sort="title-desc"
            >sort.title("z-a")</button
          >
        </div>
      </div>

      <div class="sidebar-card contribute">
        <div class="icon-wrap">
          <span>&lt;</span>
          <Icon name="plus" size={14} />
          <span>/&gt;</span>
        </div>
        <h3>yeni_blog_əlavə_et()</h3>
        <Button
          href={CONTRIBUTING_URL}
          variant="primary"
          target="_blank"
          class="contribute-btn"
        >
          github.pr_aç()
        </Button>
      </div>
    </aside>
  </div>
</BaseLayout>

<script>
  let selectedCategories: string[] = [];
  let currentSort = "date-desc";
  let searchQuery = "";

  const searchInput = document.getElementById(
    "blog-search",
  ) as HTMLInputElement;
  const blogGrid = document.querySelector(".blog-list");
  const categoryFilters = document.getElementById("category-filters");
  const sortOptions = document.getElementById("sort-options");
  const activeFiltersBox = document.getElementById("active-filters");
  const filterTags = document.getElementById("filter-tags");
  const clearFiltersBtn = document.getElementById("clear-filters");
  const emptyState = document.getElementById("empty-state");
  const resetFiltersBtn = document.getElementById("reset-filters");

  function filterAndSort() {
    if (!blogGrid) return;

    const items = Array.from(
      blogGrid.querySelectorAll(".blog-item"),
    ) as HTMLElement[];
    let visibleCount = 0;

    // Shared search matching function - matches query against title
    function matchesSearchQuery(query: string, title: string): boolean {
      if (!query) return true;
      return title.toLowerCase().includes(query.toLowerCase().trim());
    }

    items.forEach((item) => {
      const categories = JSON.parse(item.dataset.categories || "[]");
      const title = item.dataset.title || "";

      const categoryMatch =
        selectedCategories.length === 0 ||
        selectedCategories.some((cat) => categories.includes(cat));

      const searchMatch = matchesSearchQuery(searchQuery, title);

      if (categoryMatch && searchMatch) {
        item.style.display = "";
        visibleCount++;
      } else {
        item.style.display = "none";
      }
    });

    const visibleItems = items.filter((item) => item.style.display !== "none");

    visibleItems.sort((a, b) => {
      switch (currentSort) {
        case "date-desc":
          return Number(b.dataset.date) - Number(a.dataset.date);
        case "date-asc":
          return Number(a.dataset.date) - Number(b.dataset.date);
        case "title-asc":
          return (a.dataset.title || "").localeCompare(b.dataset.title || "");
        case "title-desc":
          return (b.dataset.title || "").localeCompare(a.dataset.title || "");
        default:
          return 0;
      }
    });

    visibleItems.forEach((item) => blogGrid.appendChild(item));

    if (emptyState) {
      emptyState.style.display = visibleCount === 0 ? "block" : "none";
    }

    updateActiveFilters();
  }

  function updateActiveFilters() {
    if (!activeFiltersBox || !filterTags) return;

    if (selectedCategories.length === 0 && searchQuery === "") {
      activeFiltersBox.style.display = "none";
      return;
    }

    activeFiltersBox.style.display = "flex";
    filterTags.innerHTML = "";

    selectedCategories.forEach((cat) => {
      const tag = document.createElement("span");
      tag.className = "active-tag";
      tag.innerHTML = `"${cat}" <button data-remove="${cat}">×</button>`;
      filterTags.appendChild(tag);
    });

    if (searchQuery) {
      const tag = document.createElement("span");
      tag.className = "active-tag search";
      tag.innerHTML = `query: "${searchQuery}" <button data-remove-search>×</button>`;
      filterTags.appendChild(tag);
    }

    filterTags.querySelectorAll("button[data-remove]").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const cat = (e.target as HTMLElement).getAttribute("data-remove");
        if (cat) {
          selectedCategories = selectedCategories.filter((c) => c !== cat);
          updateCategoryButtons();
          filterAndSort();
        }
      });
    });

    filterTags.querySelectorAll("button[data-remove-search]").forEach((btn) => {
      btn.addEventListener("click", () => {
        searchQuery = "";
        if (searchInput) searchInput.value = "";
        filterAndSort();
      });
    });
  }

  function updateCategoryButtons() {
    if (!categoryFilters) return;
    categoryFilters.querySelectorAll(".filter-btn").forEach((btn) => {
      const cat = btn.getAttribute("data-category");
      if (cat === "all") {
        btn.classList.toggle("active", selectedCategories.length === 0);
      } else {
        btn.classList.toggle("active", selectedCategories.includes(cat || ""));
      }
    });
  }

  categoryFilters?.addEventListener("click", (e) => {
    const target = (e.target as HTMLElement).closest(".filter-btn");
    if (!target) return;

    const category = target.getAttribute("data-category");

    if (category === "all") {
      selectedCategories = [];
    } else if (category) {
      if (selectedCategories.includes(category)) {
        selectedCategories = selectedCategories.filter((c) => c !== category);
      } else {
        selectedCategories.push(category);
      }
    }

    updateCategoryButtons();
    filterAndSort();
  });

  sortOptions?.addEventListener("click", (e) => {
    const target = (e.target as HTMLElement).closest(".sort-btn");
    if (!target) return;

    const sort = target.getAttribute("data-sort");
    if (sort) {
      currentSort = sort;
      sortOptions
        .querySelectorAll(".sort-btn")
        .forEach((btn) => btn.classList.remove("active"));
      target.classList.add("active");
      filterAndSort();
    }
  });

  searchInput?.addEventListener("input", (e) => {
    searchQuery = (e.target as HTMLInputElement).value;
    filterAndSort();
  });

  clearFiltersBtn?.addEventListener("click", () => {
    selectedCategories = [];
    searchQuery = "";
    if (searchInput) searchInput.value = "";
    updateCategoryButtons();
    filterAndSort();
  });

  resetFiltersBtn?.addEventListener("click", () => {
    selectedCategories = [];
    searchQuery = "";
    currentSort = "date-desc";
    if (searchInput) searchInput.value = "";
    updateCategoryButtons();
    sortOptions?.querySelectorAll(".sort-btn").forEach((btn) => {
      btn.classList.toggle(
        "active",
        btn.getAttribute("data-sort") === "date-desc",
      );
    });
    filterAndSort();
  });
</script>

<style>
  .page-container {
    max-width: 1120px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 1.5rem;
  }

  .content-area {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .search-row {
    margin-bottom: 1rem;
  }

  /* Filter Section */
  .filter-section {
    padding-top: 0.75rem;
    border-top: 1px solid var(--color-border);
  }

  .filter-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }

  .filter-btn {
    padding: 0.375rem 0.75rem;
    font-family: var(--font-mono);
    font-size: 0.6875rem;
    background: var(--color-surface);
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .filter-btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .filter-btn.active {
    background: var(--color-primary-muted);
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  /* Active Filters Bar */
  .active-bar {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 0.875rem;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-family: var(--font-mono);
    font-size: 0.6875rem;
    flex-wrap: wrap;
  }

  .active-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    flex: 1;
  }

  .active-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.25rem 0.5rem;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-cyan);
  }

  .active-tag.search {
    color: var(--color-orange);
  }

  :global(.active-bar .active-tag button) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    min-width: 18px;
    margin-left: 0.25rem;
    padding: 0;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text-muted);
    font-family: var(--font-mono);
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    line-height: 1;
    box-sizing: border-box;
    transition: all var(--transition-fast);
  }

  :global(.active-bar .active-tag button:hover) {
    background: var(--color-red);
    border-color: var(--color-red);
    color: white;
    transform: scale(1.05);
  }

  .clear-btn {
    padding: 0.25rem 0.625rem;
    font-family: var(--font-mono);
    font-size: 0.6875rem;
    background: transparent;
    color: var(--color-red);
    border: 1px solid var(--color-red);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .clear-btn:hover {
    background: var(--color-red-muted);
  }

  /* Empty State */
  .empty-box .window-body {
    text-align: center;
    padding: 3rem 2rem;
  }

  .empty-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  .shrug {
    font-size: 3rem;
    line-height: 1;
    color: var(--color-text-muted);
  }

  .empty-msg {
    font-family: var(--font-mono);
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin: 0;
  }

  .reset-btn {
    padding: 0.5rem 1rem;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    background: var(--color-primary-muted);
    color: var(--color-primary);
    border: 1px solid var(--color-primary);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    margin-top: 0.5rem;
  }

  .reset-btn:hover {
    background: var(--color-primary);
    color: var(--color-bg);
  }

  /* Sidebar */
  .sidebar {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    position: sticky;
    top: 5rem;
    height: fit-content;
  }

  /* Sort */
  .sort-list {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .sort-btn {
    padding: 0.5rem 0.625rem;
    font-family: var(--font-mono);
    font-size: 0.6875rem;
    background: transparent;
    color: var(--color-text-secondary);
    border: 1px solid transparent;
    border-radius: var(--radius-sm);
    cursor: pointer;
    text-align: left;
    transition: all var(--transition-fast);
  }

  .sort-btn:hover {
    background: var(--color-bg-secondary);
    color: var(--color-text);
  }

  .sort-btn.active {
    background: var(--color-primary-muted);
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  /* Featured */
  .featured-list {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .featured-link {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    padding: 0.5rem;
    font-family: var(--font-mono);
    font-size: 0.6875rem;
    color: var(--color-text-secondary);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-sm);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .featured-link:hover {
    color: var(--color-primary);
  }

  .featured-link .arrow {
    color: var(--color-cyan);
    flex-shrink: 0;
  }

  .featured-link .title {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Contribute */
  .contribute {
    text-align: center;
    padding: 1.25rem;
  }

  .icon-wrap {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    color: var(--color-primary);
    margin-bottom: 0.5rem;
  }

  .icon-wrap span {
    color: var(--color-text-muted);
  }

  .contribute h3 {
    font-size: 0.6875rem;
    margin-bottom: 0.75rem;
    text-align: center;
  }

  .contribute-btn {
    display: flex;
    width: 100%;
    font-size: 0.6875rem;
    justify-content: center;
  }

  @media (max-width: 1024px) {
    .page-container {
      display: flex;
      flex-direction: column;
    }

    .content-area {
      display: contents;
    }

    :global(.page-header) {
      order: 1;
    }

    :global(.active-bar) {
      order: 2;
    }

    .sidebar {
      position: static;
      flex-direction: row;
      flex-wrap: wrap;
      order: 3;
      margin-bottom: 1rem;
    }

    :global(.blog-list) {
      order: 4;
    }

    :global(#empty-state) {
      order: 4;
    }

    .sidebar-card {
      flex: 1;
      min-width: 180px;
    }
  }
</style>
